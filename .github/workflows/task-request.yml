name: Notify Discord on Assigned Issues or Task Requests

on:
  issues:
    types: [assigned, opened] # 이슈가 할당되거나 새로 생성될 때 실행

jobs:
  notify-discord:
    runs-on: ubuntu-latest
    steps:
      - name: Set Environment Variables
        run: |
          echo "ASSIGNEE=${{ github.event.issue.assignee.login }}" >> $GITHUB_ENV
          echo "ISSUE_URL=${{ github.event.issue.html_url }}" >> $GITHUB_ENV
          echo "ISSUE_TITLE=${{ github.event.issue.title }}" >> $GITHUB_ENV
          echo "WEBHOOK_URL=${{ secrets.DISCORD_WEBHOOK_URL }}" >> $GITHUB_ENV

      - name: Check Assignee or Title & Send Discord Notification
        run: |
          JSON_FILE=$(mktemp)
          TITLE_MATCH=false

          # 제목이 '✅ Task Request -'로 시작하는지 확인
          if [[ "$ISSUE_TITLE" =~ ^✅\ Task\ Request\ - ]]; then
            TITLE_MATCH=true
          fi

          # 조건 만족 시 Discord 알림 전송
          if [[ "$TITLE_MATCH" == "true" ]]; then
            echo '{' > $JSON_FILE
            echo '  "content": "📢 **이슈가 감지되었습니다!**",' >> $JSON_FILE
            echo '  "embeds": [' >> $JSON_FILE
            echo '    {' >> $JSON_FILE
            echo '      "title": "🔗 [GitHub 이슈 링크]('$ISSUE_URL')",' >> $JSON_FILE
            echo '      "description": "**이슈 제목:** '$ISSUE_TITLE'",' >> $JSON_FILE
            echo '      "color": 15258703,' >> $JSON_FILE
            echo '      "footer": {"text": "GitHub Actions | Issue Alert"},' >> $JSON_FILE
            echo '      "timestamp": "'$(date -u +'%Y-%m-%dT%H:%M:%SZ')'"' >> $JSON_FILE
            echo '    }' >> $JSON_FILE
            echo '  ]' >> $JSON_FILE
            echo '}' >> $JSON_FILE

            curl -X POST -H 'Content-type: application/json' --data @$JSON_FILE $WEBHOOK_URL
            rm $JSON_FILE
          fi
